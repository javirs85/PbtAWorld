@page "/SeasonSelection"
@inject MetaController Meta;
@inject NavigationManager nav;

<PageTitle>Seleccione temporada</PageTitle>

<div class="FullPage">
	<div class="DarkUpperMenu">
		<i class="bi bi-arrow-left-short fs-1 p-2" style="cursor:pointer;" @onclick=GoBack></i>
		<p class="mt-3">@Meta.SelectedGame.ToUI()</p>
		<i class="bi bi-arrow-left-short fs-1 p-2" style="cursor:pointer; color:black" @onclick=GoBack></i>
	</div>
	<div class="Title">Elije temporada</div>
	<div class="d-flex gap-2 p-2">
		<img src="@Meta.SelectedGameCover" style="height: 340px;"/>
		<div class="d-flex flex-column gap-2">
			<div class="d-flex flex-column gap-2" style="min-height: 255px;">
				@foreach(var season in Meta.Seasons)
				{
					<div class="SeasonBox" @onclick=@(()=>{SelectSeason(season);})>@season.Name</div>
				}
			</div>
			<div class="p-4" style="background: black;">
				<EditForm Model="@newSeason">
					<label class="col-form-label-sm">Nueva temporada:</label>
					<InputText @bind-Value=newSeason.Name class="form-control">Titulo de la nueva temporada</InputText>
                    <div class="mt-2 btn btn-primary" @onclick=Submit>Empezar una nueva temporada</div>
				</EditForm>
			</div>
		</div>
	</div>
</div>

@code {
	protected override async Task OnInitializedAsync()
	{
		Meta.OnUpdateRequested += (o, e) => { InvokeAsync(() => { StateHasChanged(); }); };
		await Meta.LoadAllSessionsOfSelectedGame();
	}

	private async Task Submit()
	{
		newSeason.GameID = Meta.SelectedGame?? AvailableGames.NotSet;
		await Meta.StoreSeasonAsNewSeason(newSeason);
	}

	private void SelectSeason(Season season)
	{
		Meta.SelectedSeason = season;
		nav.NavigateTo("/SeasonViewer");
	}

	private Season newSeason = new Season();

	private void GoBack(){
		Meta.SelectedGame = null;
		nav.NavigateTo("/");
	}
}
